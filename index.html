<!doctype html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<title>Galactic Trial</title>
<style>
*{box-sizing:border-box}html,body{margin:0;width:100%;height:100%;overflow:hidden;touch-action:none;background:#060b12;color:#f0f6ff;font-family:Trebuchet MS,Segoe UI,sans-serif}
#game{position:fixed;inset:0;width:100vw;height:100vh;display:block}
#hud{position:fixed;top:max(10px,env(safe-area-inset-top));left:max(10px,env(safe-area-inset-left));right:max(10px,env(safe-area-inset-right));z-index:8;display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-radius:14px;background:linear-gradient(135deg,rgba(6,12,20,.72),rgba(16,29,45,.56));border:1px solid rgba(180,220,255,.22)}
#title{font-weight:900;letter-spacing:.08em}#stats{font-weight:700;display:flex;gap:12px;align-items:center}
.mini{height:34px;padding:0 12px;border-radius:10px;border:1px solid rgba(210,230,255,.44);background:linear-gradient(165deg,rgba(16,27,41,.9),rgba(10,18,28,.82));color:#fff;font-weight:900;font-size:12px;letter-spacing:.04em}
.mini.off{opacity:.72}
#cheat{position:fixed;top:max(58px,calc(16px + env(safe-area-inset-top)));left:50%;transform:translateX(-50%);z-index:9;padding:8px 14px;border-radius:10px;border:1px solid rgba(255,220,120,.65);background:rgba(75,45,10,.72);font-weight:900;display:none}
#msg{position:fixed;top:max(98px,calc(60px + env(safe-area-inset-top)));left:50%;transform:translateX(-50%);z-index:9;padding:8px 14px;border-radius:10px;border:1px solid rgba(160,220,255,.65);background:rgba(12,34,56,.78);font-weight:900;opacity:0;transition:opacity .2s}
#msg.show{opacity:1}
#controls{position:fixed;z-index:10;left:max(10px,env(safe-area-inset-left));right:max(10px,env(safe-area-inset-right));bottom:max(10px,env(safe-area-inset-bottom));display:flex;justify-content:space-between;pointer-events:none}
.pad{display:flex;gap:10px;pointer-events:auto}.b{width:78px;height:78px;border-radius:18px;border:1px solid rgba(210,230,255,.44);background:linear-gradient(165deg,rgba(16,27,41,.9),rgba(10,18,28,.82));color:#fff;font-weight:900;font-size:22px}.b:active,.b.on{transform:translateY(2px) scale(.98)}
#rotate{position:fixed;inset:0;display:none;z-index:20;place-items:center;text-align:center;padding:24px;background:rgba(2,6,10,.95);font-size:6vw;font-weight:900}
#win{position:fixed;inset:0;display:none;z-index:15;place-items:center;background:rgba(0,0,0,.74)}#win>div{background:linear-gradient(145deg,#101b2a,#0a1320);padding:24px;border:1px solid rgba(190,220,255,.35);border-radius:16px;text-align:center}
@media (orientation:portrait){#rotate{display:grid}#game,#hud,#controls,#cheat,#msg{filter:blur(2px) brightness(.7)}}
</style>
</head>
<body>
<div id="rotate">Переверни телефон в горизонтальный режим</div>
<div id="hud"><span id="title">GALACTIC TRIAL</span><span id="stats"><span id="level">Уровень 1/10</span><span id="deaths">Смерти: 0</span><span id="time">Время: 0.0с</span><button id="musicBtn" class="mini">МУЗЫКА: ВКЛ</button></span></div>
<div id="cheat">ВЫ ПОД ЧИТКОДОМ</div>
<div id="msg"></div>
<canvas id="game"></canvas>
<div id="controls"><div class="pad"><button id="l" class="b">◀</button><button id="r" class="b">▶</button></div><div class="pad"><button id="j" class="b">J</button><button id="d" class="b">D</button></div></div>
<div id="win"><div><h2>Все 10 уровней пройдены</h2><p id="res"></p><button id="retry" class="b" style="width:190px;height:56px;font-size:16px">Еще раз</button></div></div>
<script src="assets/music/music-inline.js"></script>
<script>
const cv=document.getElementById('game'),cx=cv.getContext('2d',{alpha:false});
const levelEl=document.getElementById('level'),deathsEl=document.getElementById('deaths'),timeEl=document.getElementById('time'),msgEl=document.getElementById('msg');
const win=document.getElementById('win'),res=document.getElementById('res'),cheatEl=document.getElementById('cheat');
const LEVELS=10,H=1300;
const p={x:120,y:920,w:34,h:44,vx:0,vy:0,f:1,g:false,c:0,jb:0,dc:0,ds:0,dd:1};
const ph={spd:360,acc:3000,fr:3400,gr:2100,j:810,mf:1250,ct:.09,jbt:.12,dh:840,dd:.16,cd:.72};
let keys=new Set(),inp={l:false,r:false,j:false,d:false},cam={x:0,y:0};
let cur=null,level=0,deaths=0,start=performance.now(),done=false,cheat=false,cheatHold=0,lastTaunt=0,msgTo=0,levelLockUntil=0;
const themes=[
{name:'Орбита Титана',top:'#070b1a',mid:'#10243f',bot:'#1c3659',neb:'#3b5e95',planet:'#89b4ff'},
{name:'Багровая туманность',top:'#16070d',mid:'#3a1020',bot:'#5d1e35',neb:'#9b3b62',planet:'#ff9eb1'},
{name:'Ледяной космос',top:'#07141f',mid:'#113a4e',bot:'#1a5670',neb:'#5ca6c6',planet:'#d4f4ff'},
{name:'Песчаная система',top:'#140f09',mid:'#3e2a15',bot:'#6b4722',neb:'#b67c3a',planet:'#ffd58f'},
{name:'Изумрудная даль',top:'#05140f',mid:'#0d3d2b',bot:'#186847',neb:'#38a173',planet:'#b9ffd8'},
{name:'Фиолетовый шторм',top:'#12081f',mid:'#2d0f4f',bot:'#4c1a78',neb:'#7d4cc4',planet:'#dbc1ff'},
{name:'Голубой гигант',top:'#040f20',mid:'#0b2f63',bot:'#134c9b',neb:'#3d7bdf',planet:'#a7d0ff'},
{name:'Пепельный пояс',top:'#111214',mid:'#282c33',bot:'#3d4450',neb:'#5e6878',planet:'#c7ceda'},
{name:'Неоновая сингулярность',top:'#090013',mid:'#2a0442',bot:'#4f0b77',neb:'#bc38ff',planet:'#ffb7ff'},
{name:'Корона звезды',top:'#150a00',mid:'#4b1f00',bot:'#7a3000',neb:'#e46a23',planet:'#ffd29a'}
];
const svg=s=>{const i=new Image();i.src='data:image/svg+xml;utf8,'+encodeURIComponent(s);return i};
const art={spike:svg("<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 220 60'><g fill='#9da7b9'><path d='M0 60 L16 8 L32 60Z'/><path d='M28 60 L44 6 L60 60Z'/><path d='M56 60 L72 10 L88 60Z'/><path d='M84 60 L100 6 L116 60Z'/><path d='M112 60 L128 8 L144 60Z'/><path d='M140 60 L156 6 L172 60Z'/><path d='M168 60 L184 10 L200 60Z'/><path d='M196 60 L210 8 L220 60Z'/></g></svg>"),saw:svg("<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 160 160'><defs><radialGradient id='m' cx='50%' cy='50%' r='50%'><stop offset='0' stop-color='#f1f6ff'/><stop offset='1' stop-color='#8a96ab'/></radialGradient></defs><g transform='translate(80,80)'><path d='M0,-72 L10,-52 L32,-64 L28,-40 L52,-38 L36,-20 L58,-8 L34,2 L44,24 L20,20 L16,46 L0,28 L-16,46 L-20,20 L-44,24 L-34,2 L-58,-8 L-36,-20 L-52,-38 L-28,-40 L-32,-64 L-10,-52 Z' fill='url(#m)'/><circle r='27' fill='#5f6f83'/><circle r='10' fill='#d9e6f8'/></g></svg>"),emitter:svg("<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 80 220'><rect x='18' y='0' width='44' height='220' rx='12' fill='#111827'/><rect x='30' y='8' width='20' height='204' rx='8' fill='#2c374a'/></svg>")};
const cl=(v,a,b)=>Math.max(a,Math.min(b,v)),hit=(a,b)=>a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y;
const chr=(x,y,r,o)=>{const nx=cl(x,o.x,o.x+o.w),ny=cl(y,o.y,o.y+o.h),dx=x-nx,dy=y-ny;return dx*dx+dy*dy<=r*r};
const rr=(x,y,w,h,r)=>{const q=Math.min(r,w*.5,h*.5);cx.beginPath();cx.moveTo(x+q,y);cx.lineTo(x+w-q,y);cx.quadraticCurveTo(x+w,y,x+w,y+q);cx.lineTo(x+w,y+h-q);cx.quadraticCurveTo(x+w,y+h,x+w-q,y+h);cx.lineTo(x+q,y+h);cx.quadraticCurveTo(x,y+h,x,y+h-q);cx.lineTo(x,y+q);cx.quadraticCurveTo(x,y,x+q,y);cx.closePath()};
const rng=s=>()=>((s=(s*1664525+1013904223)>>>0)/4294967296);
let dpr=1,bg=document.createElement('canvas');
function showMsg(t,ms=1800){msgEl.textContent=t;msgEl.classList.add('show');clearTimeout(msgTo);msgTo=setTimeout(()=>msgEl.classList.remove('show'),ms)}
function buildSky(){const w=innerWidth,h=innerHeight;bg.width=Math.floor(w*dpr);bg.height=Math.floor(h*dpr);const s=bg.getContext('2d');s.setTransform(dpr,0,0,dpr,0,0);const th=cur.theme;const g=s.createLinearGradient(0,0,0,h);g.addColorStop(0,th.top);g.addColorStop(.55,th.mid);g.addColorStop(1,th.bot);s.fillStyle=g;s.fillRect(0,0,w,h);for(let i=0;i<3;i++){const rr=parseInt(th.neb.slice(1,3),16),gg=parseInt(th.neb.slice(3,5),16),bb=parseInt(th.neb.slice(5,7),16);s.fillStyle='rgba('+rr+','+gg+','+bb+','+(0.08+i*0.03)+')';s.beginPath();s.ellipse((i*430+80)%w,180+i*90,220,70,0,0,Math.PI*2);s.fill()}s.fillStyle=th.planet;s.globalAlpha=.24;s.beginPath();s.arc(w-220,170,95,0,Math.PI*2);s.fill();s.globalAlpha=1}
function resize(){dpr=Math.min(devicePixelRatio||1,1.25);cv.width=Math.floor(innerWidth*dpr);cv.height=Math.floor(innerHeight*dpr);cx.setTransform(dpr,0,0,dpr,0,0);if(cur)buildSky()}
function levelGen(i){
const r=rng(3001+i*177);const width=4400+i*520;const start={x:120,y:920};
const platforms=[{x:0,y:1060,w:560,h:220,type:'solid'}];
let prev=platforms[0],cursor=prev.x+prev.w;
const segments=16+i*2;
const easy=i<3,hard=i>6;
const riseMin=easy?-64:hard?-92:-82,riseMax=easy?74:hard?108:92;
const platformSpikeChance=easy?0.1:hard?0.29:0.21;
const crumbleStep=easy?7:hard?4:6;
for(let n=0;n<segments;n++){
const gapMin=n<3?(easy?96:108):(easy?116:hard?138:126),gapMax=n<3?(easy?148:170):(easy?188:hard?228:214),gap=gapMin+Math.floor(r()*(gapMax-gapMin+1));
const w=128+Math.floor(r()*82),x=cursor+gap;
let y=prev.y+Math.floor((r()-.5)*(easy?122:hard?168:150));y=cl(y,prev.y+riseMin,prev.y+riseMax);y=cl(y,340,980);
const t=((n+i)%crumbleStep===0&&n>3)?'crumble':'solid';
const p={x,y,w,h:22,type:t,timer:0,gone:false,restore:0};
platforms.push(p);prev=p;cursor=x+w;
}
let last=prev;
if(width-760>last.x+last.w+120){
const bridge={x:width-760,y:cl(last.y-(28+Math.floor(r()*34)),300,860),w:220,h:22,type:'solid'};
platforms.push(bridge);last=bridge;
}
const finalY=Math.max(220,last.y-(20+Math.floor(r()*28)));
const finalPlatform={x:width-410,y:finalY,w:350,h:24,type:'solid'};platforms.push(finalPlatform);
const goal={x:finalPlatform.x+finalPlatform.w-86,y:finalPlatform.y-84,w:64,h:84};

const spikes=[];
const groundSpikeBands=(easy?4:5)+i;
for(let g=0;g<groundSpikeBands;g++){const sx=960+Math.floor(g*(width-1700)/groundSpikeBands);spikes.push({x:sx,y:1042,w:64+Math.floor(r()*(hard?92:80)),h:18})}
for(let idx=4;idx<platforms.length-2;idx++){
const t=platforms[idx];if(t.y>=900||t.type!=='solid'||r()>=platformSpikeChance)continue;
const sw=Math.max(44,Math.min(96,t.w-90));const sx=t.x+45+Math.floor(r()*Math.max(8,t.w-sw-90));
spikes.push({x:sx,y:t.y-18,w:sw,h:18});
}

const sawCount=(easy?1:2)+Math.floor(i/2)+(hard?1:0);
const saws=[];for(let s=0;s<sawCount;s++){saws.push({cx:1450+Math.floor(r()*(width-2400)),cy:360+Math.floor(r()*560),r:20+Math.floor(r()*10),a:r()<0.5?'x':'y',amp:110+Math.floor(r()*160),sp:2+r()*(hard?2.1:1.8),ph:r()*6.28})}
const laserCount=(easy?1:2)+Math.floor(i/3)+(hard?1:0);
const lasers=[];for(let l=0;l<laserCount;l++){lasers.push({x:1600+Math.floor(r()*(width-2700)),y:180+Math.floor(r()*240),w:16,h:820-Math.floor(r()*150),per:(hard?1.05:1.2)+r()*0.8,on:(easy?0.48:0.55)+r()*(hard?0.5:0.45),ph:r()*1.1})}
const stars=[];for(let k=0;k<56;k++)stars.push({x:r(),y:r(),a:0.2+r()*0.65,s:1+r()*1.5,p:r()*6.28});
return{width,height:H,start,goal,platforms,spikes,saws,lasers,stars,theme:themes[i]}}
function loadLevel(i,withTransition){cur=levelGen(i);p.x=cur.start.x;p.y=cur.start.y;p.vx=0;p.vy=0;buildSky();levelEl.textContent='Уровень '+(i+1)+'/10';if(withTransition){levelLockUntil=performance.now()+900;showMsg('ПЕРЕХОД НА УРОВЕНЬ '+(i+1),950)}setTimeout(()=>showMsg('УРОВЕНЬ '+(i+1)+': '+cur.theme.name,1700),withTransition?420:0)}
function resetAll(){deaths=0;start=performance.now();done=false;cheat=false;cheatHold=0;cheatEl.style.display='none';level=0;levelLockUntil=0;loadLevel(0,false);win.style.display='none'}
function die(){if(done)return;sfx('death');taunt();deaths++;p.x=cur.start.x;p.y=cur.start.y;p.vx=0;p.vy=0}
function bind(id,d,u){const b=document.getElementById(id);const on=e=>{e.preventDefault();audioOn();b.classList.add('on');d()};const off=e=>{e.preventDefault();b.classList.remove('on');u()};b.addEventListener('touchstart',on,{passive:false});b.addEventListener('mousedown',on);['touchend','touchcancel','mouseup','mouseleave'].forEach(ev=>b.addEventListener(ev,off))}
bind('l',()=>inp.l=true,()=>inp.l=false);bind('r',()=>inp.r=true,()=>inp.r=false);bind('j',()=>inp.j=true,()=>{});bind('d',()=>inp.d=true,()=>{});
addEventListener('keydown',e=>{audioOn();keys.add(e.code);if(['ArrowUp','Space','KeyW'].includes(e.code))inp.j=true;if(['ShiftLeft','ShiftRight','KeyK'].includes(e.code))inp.d=true});
addEventListener('keyup',e=>keys.delete(e.code));addEventListener('resize',resize);document.getElementById('retry').onclick=resetAll;
let actx=null,aReady=false,musicOn=false,musicIdx=0,musicEl=new Audio(),musicGain=null,musicEnabled=true;
const configuredTracks=(window.MY_MUSIC&&Array.isArray(window.MY_MUSIC.tracks))?window.MY_MUSIC.tracks:[];
const configuredTaunts=(window.MY_MUSIC&&Array.isArray(window.MY_MUSIC.taunts))?window.MY_MUSIC.taunts:[];
const skillbossTracks=configuredTracks;
const tauntClips=configuredTaunts.map((src)=>new Audio(src));
for(const a of tauntClips){a.preload='auto';a.volume=0.92}
const musicBtn=document.getElementById('musicBtn');
function syncMusicBtn(){musicBtn.textContent='МУЗЫКА: '+(musicEnabled?'ВКЛ':'ВЫКЛ');musicBtn.classList.toggle('off',!musicEnabled)}
function stopMusic(){musicOn=false;musicEl.pause();musicEl.currentTime=0;if(musicGain){try{musicGain.disconnect()}catch{}musicGain=null}}
function startSynthMusic(){if(!actx||!musicEnabled||musicOn)return;musicOn=true;const g=actx.createGain();g.gain.value=.022;g.connect(actx.destination);musicGain=g;const t=actx.currentTime;const mk=(f,ty)=>{const o=actx.createOscillator();o.type=ty;o.frequency.setValueAtTime(f,t);o.connect(g);o.start();return o};const a=mk(164.81,'triangle'),b=mk(246.94,'sine'),c=mk(329.63,'triangle');const l=actx.createOscillator(),lg=actx.createGain();l.frequency.value=.25;lg.gain.value=14;l.connect(lg);lg.connect(a.frequency);l.start()}
function startMusic(){if(!musicEnabled||musicOn)return;if(skillbossTracks.length){musicOn=true;musicEl.volume=0.42;musicEl.preload='auto';musicEl.loop=false;musicEl.src=skillbossTracks[musicIdx%skillbossTracks.length];musicEl.play().catch(()=>{});musicEl.onended=()=>{if(!musicEnabled)return;musicIdx++;musicEl.src=skillbossTracks[musicIdx%skillbossTracks.length];musicEl.play().catch(()=>{})};return}startSynthMusic()}
function audioOn(){if(!actx){const C=window.AudioContext||window.webkitAudioContext;if(!C)return;actx=new C()}if(actx.state==='suspended')actx.resume();aReady=true;startMusic()}
musicBtn.onclick=()=>{audioOn();musicEnabled=!musicEnabled;if(!musicEnabled)stopMusic();else startMusic();syncMusicBtn()};syncMusicBtn();
function sfx(t){if(!actx||!aReady)return;const n=actx.currentTime,o=actx.createOscillator(),g=actx.createGain();o.connect(g);g.connect(actx.destination);if(t==='jump'){o.type='triangle';o.frequency.setValueAtTime(280,n);o.frequency.exponentialRampToValueAtTime(520,n+.09);g.gain.setValueAtTime(.0001,n);g.gain.exponentialRampToValueAtTime(.05,n+.01);g.gain.exponentialRampToValueAtTime(.0001,n+.11);o.start(n);o.stop(n+.12);return}if(t==='dash'){o.type='sawtooth';o.frequency.setValueAtTime(145,n);o.frequency.exponentialRampToValueAtTime(92,n+.12);g.gain.setValueAtTime(.0001,n);g.gain.exponentialRampToValueAtTime(.07,n+.01);g.gain.exponentialRampToValueAtTime(.0001,n+.14);o.start(n);o.stop(n+.15);return}if(t==='death'){o.type='square';o.frequency.setValueAtTime(180,n);o.frequency.exponentialRampToValueAtTime(58,n+.3);g.gain.setValueAtTime(.0001,n);g.gain.exponentialRampToValueAtTime(.07,n+.01);g.gain.exponentialRampToValueAtTime(.0001,n+.32);o.start(n);o.stop(n+.33);return}o.type='triangle';o.frequency.setValueAtTime(330,n);o.frequency.exponentialRampToValueAtTime(660,n+.22);g.gain.setValueAtTime(.0001,n);g.gain.exponentialRampToValueAtTime(.06,n+.02);g.gain.exponentialRampToValueAtTime(.0001,n+.28);o.start(n);o.stop(n+.29)}
function taunt(){
const now=performance.now();if(now-lastTaunt<1500)return;lastTaunt=now;
if(tauntClips.length){const pick=tauntClips[Math.floor(Math.random()*tauntClips.length)];try{pick.currentTime=0;pick.play().catch(()=>{})}catch{}}
else if('speechSynthesis'in window){const styles=[{text:'Ты не пройдешь.',rate:0.82,pitch:0.52},{text:'ТЫ НЕ ПРОЙДЕШЬ! Ха-ха!',rate:1.06,pitch:0.86},{text:'Не-а, дальше дороги нет.',rate:0.95,pitch:0.64},{text:'Ты не пройдешь... попробуй снова.',rate:0.9,pitch:0.4}],pick=styles[Math.floor(Math.random()*styles.length)],u=new SpeechSynthesisUtterance(pick.text);u.lang='ru-RU';u.rate=pick.rate;u.pitch=pick.pitch;const voices=speechSynthesis.getVoices().filter(v=>v.lang&&v.lang.toLowerCase().startsWith('ru'));if(voices.length)u.voice=voices[Math.floor(Math.random()*voices.length)];speechSynthesis.cancel();speechSynthesis.speak(u)}
}
function solid(){return cur.platforms.filter(t=>t.type!=='crumble'||!t.gone)}
function update(dt,et){for(const t of cur.platforms)if(t.type==='crumble'&&t.gone){t.restore-=dt;if(t.restore<=0){t.gone=false;t.timer=0}}
const left=inp.l||keys.has('ArrowLeft')||keys.has('KeyA'),right=inp.r||keys.has('ArrowRight')||keys.has('KeyD');
if(!cheat&&left&&right){cheatHold+=dt;if(cheatHold>=5){cheat=true;cheatEl.style.display='block';showMsg('ЧИТКОД АКТИВЕН',1600)}}else if(!cheat)cheatHold=0;
const m=(right?1:0)-(left?1:0);if(m)p.f=m;if(inp.j)p.jb=ph.jbt;if(inp.d&&p.dc<=0&&!p.ds){sfx('dash');p.ds=ph.dd;p.dd=m||p.f||1;p.vx=p.dd*ph.dh;p.vy=0;p.dc=ph.cd}inp.j=false;inp.d=false;p.jb-=dt;p.c-=dt;p.dc-=dt;
if(p.ds>0){p.ds-=dt;p.vx=p.dd*ph.dh;p.vy=0}else{const tgt=m*ph.spd;if(m){const dir=Math.sign(tgt-p.vx);p.vx+=dir*ph.acc*dt;if((dir>0&&p.vx>tgt)||(dir<0&&p.vx<tgt))p.vx=tgt}else{const f=Math.sign(p.vx),a=ph.fr*dt;p.vx=Math.abs(p.vx)<=a?0:p.vx-f*a}p.vy=Math.min(p.vy+ph.gr*dt,ph.mf)}
if(p.jb>0&&(p.g||p.c>0)){sfx('jump');p.vy=-ph.j;p.g=false;p.c=0;p.jb=0}
const sld=solid();p.x+=p.vx*dt;for(const t of sld){if(!hit(p,t))continue;if(p.vx>0)p.x=t.x-p.w;else if(p.vx<0)p.x=t.x+t.w;p.vx=0}
p.y+=p.vy*dt;p.g=false;for(const t of sld){if(!hit(p,t))continue;if(p.vy>0){p.y=t.y-p.h;p.vy=0;p.g=true;p.c=ph.ct;if(t.type==='crumble'){t.timer+=dt;if(t.timer>.28){t.gone=true;t.restore=2.4}}}else if(p.vy<0){p.y=t.y+t.h;p.vy=0}}
if(!p.g)for(const t of cur.platforms)if(t.type==='crumble')t.timer=0;p.x=cl(p.x,0,cur.width-p.w);
if(!cheat){for(const s of cur.spikes)if(hit(p,s))return die();for(const s of cur.saws){const tt=et*s.sp+s.ph,x=s.cx+(s.a==='x'?Math.sin(tt)*s.amp:0),y=s.cy+(s.a==='y'?Math.sin(tt)*s.amp:0);if(chr(x,y,s.r,p))return die()}for(const l of cur.lasers){if(((et+l.ph)%l.per)<l.on&&hit(p,l))return die()}}
if(p.y>cur.height+120)return die();if(hit(p,cur.goal)){if(level<LEVELS-1){level++;loadLevel(level,true);return}else{done=true;sfx('win');win.style.display='grid';res.textContent='Смерти: '+deaths+' | Время: '+((performance.now()-start)/1000).toFixed(2)+'с'}}}
function hero(et){const bw=54,bh=82,bx=p.x+(p.w-bw)*.5,by=p.y+p.h-bh+3,mv=Math.abs(p.vx)>45,s=(mv?1:.2)*Math.sin(et*14+Math.abs(p.vx)*.01)*.45,tr=p.ds>0?3:mv?1:0;cx.save();if(p.f<0){cx.translate(bx+bw*.5,0);cx.scale(-1,1);cx.translate(-(bx+bw*.5),0)}for(let i=tr;i>=1;i--){cx.globalAlpha=.09+i*.05;body(bx-i*5,by+i*.7,s*.5)}cx.globalAlpha=1;body(bx,by,s);if(mv||p.ds>0){const len=p.ds>0?50:30,pulse=.4+Math.abs(Math.sin(et*19))*.45;cx.fillStyle='rgba(255,68,68,'+pulse+')';cx.fillRect(bx+bw-4,by+34,len,4);cx.fillStyle='rgba(255,194,194,'+(pulse*.8)+')';cx.fillRect(bx+bw-4,by+35,len,2)}cx.restore()}
function body(x,y,s){const cape=cx.createLinearGradient(x,y+8,x+54,y+82);cape.addColorStop(0,'#131720');cape.addColorStop(1,'#2a3140');cx.fillStyle=cape;cx.beginPath();cx.moveTo(x+8,y+26);cx.lineTo(x-4,y+78);cx.lineTo(x+22,y+70);cx.lineTo(x+50,y+82);cx.lineTo(x+42,y+30);cx.closePath();cx.fill();cx.save();cx.translate(x+20,y+52);cx.rotate(s);cx.fillStyle='#141b26';rr(-8,0,16,28,6);cx.fill();cx.restore();cx.save();cx.translate(x+34,y+52);cx.rotate(-s);cx.fillStyle='#141b26';rr(-8,0,16,28,6);cx.fill();cx.restore();cx.fillStyle='#1e2633';rr(x+12,y+24,30,28,8);cx.fill();cx.fillStyle='#0f141e';rr(x+18,y+28,18,12,3);cx.fill();cx.fillStyle='#7ff6c0';cx.fillRect(x+19,y+29,3,3);cx.fillStyle='#74d7ff';cx.fillRect(x+24,y+29,3,3);cx.fillStyle='#ff7171';cx.fillRect(x+29,y+29,3,3);cx.fillStyle='#111723';cx.beginPath();cx.ellipse(x+27,y+14,12,14,0,0,Math.PI*2);cx.fill();cx.fillStyle='#293444';cx.beginPath();cx.ellipse(x+27,y+12,8,8,0,0,Math.PI*2);cx.fill();cx.fillStyle='#d5e1f5';cx.fillRect(x+22,y+15,3,2);cx.fillRect(x+29,y+15,3,2)}
function draw(et){const w=innerWidth,h=innerHeight;cx.drawImage(bg,0,0,w,h);for(const s of cur.stars){const x=(s.x*w-et*(6+s.s*4))%w;cx.fillStyle='rgba(220,235,255,'+s.a+')';cx.fillRect((x+w)%w,s.y*h,2,2)}cx.save();cx.translate(-cam.x,-cam.y);
cx.fillStyle='#8fd2ff';cx.fillRect(cur.start.x-12,cur.start.y-100,12,100);cx.fillStyle='#dff5ff';cx.fillRect(cur.start.x,cur.start.y-92,42,24);cx.fillStyle='#0e141d';cx.font='700 22px Trebuchet MS';cx.fillText('A',cur.start.x+12,cur.start.y-74);
cx.fillStyle='#506882';rr(cur.goal.x,cur.goal.y,cur.goal.w,cur.goal.h,6);cx.fill();cx.fillStyle='#b8d7ff';rr(cur.goal.x+18,cur.goal.y+18,28,48,4);cx.fill();cx.fillStyle='#102016';cx.fillText('B',cur.goal.x+22,cur.goal.y-10);
for(const t of cur.platforms){if(t.type==='crumble'&&t.gone)continue;const pg=cx.createLinearGradient(t.x,t.y,t.x,t.y+t.h);pg.addColorStop(0,t.type==='crumble'?'#8a7f5d':'#46566d');pg.addColorStop(1,t.type==='crumble'?'#58503a':'#2e3948');cx.fillStyle=pg;rr(t.x,t.y,t.w,t.h,4);cx.fill();cx.fillStyle='rgba(255,255,255,.14)';cx.fillRect(t.x+2,t.y+2,t.w-4,2)}
for(const s of cur.spikes){const n=Math.max(1,Math.ceil(s.w/28)),sw=s.w/n;for(let i=0;i<n;i++)cx.drawImage(art.spike,s.x+i*sw,s.y-1,sw+1,s.h+3)}
for(const l of cur.lasers){const a=((et+l.ph)%l.per)<l.on;cx.drawImage(art.emitter,l.x-32,l.y-6,80,l.h+12);cx.fillStyle=a?'rgba(255,75,75,.88)':'rgba(255,75,75,.18)';cx.fillRect(l.x,l.y,l.w,l.h);if(a){cx.fillStyle='rgba(255,210,210,.92)';cx.fillRect(l.x+5,l.y,4,l.h)}}
for(const s of cur.saws){const tt=et*s.sp+s.ph,x=s.cx+(s.a==='x'?Math.sin(tt)*s.amp:0),y=s.cy+(s.a==='y'?Math.sin(tt)*s.amp:0);cx.strokeStyle='rgba(220,235,255,.24)';cx.lineWidth=3;cx.beginPath();if(s.a==='x'){cx.moveTo(s.cx-s.amp,s.cy);cx.lineTo(s.cx+s.amp,s.cy)}else{cx.moveTo(s.cx,s.cy-s.amp);cx.lineTo(s.cx,s.cy+s.amp)}cx.stroke();cx.save();cx.translate(x,y);cx.rotate(et*3.2);cx.drawImage(art.saw,-s.r,-s.r,s.r*2,s.r*2);cx.restore()}
hero(et);cx.restore()}
let prev=performance.now();resize();resetAll();requestAnimationFrame(function loop(now){const dt=Math.min(.033,(now-prev)/1000);prev=now;const et=(now-start)/1000;if(!done){if(now>=levelLockUntil)update(dt,et);cam.x=cl(p.x-innerWidth*.34,0,cur.width-innerWidth);cam.y=cl(p.y-innerHeight*.56,0,cur.height-innerHeight)}draw(et);deathsEl.textContent='Смерти: '+deaths;timeEl.textContent='Время: '+et.toFixed(1)+'с';requestAnimationFrame(loop)});
</script>
</body>
</html>
